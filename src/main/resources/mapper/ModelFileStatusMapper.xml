<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ydsw.dao.ModelFileStatusMapper">

    <resultMap id="BaseResultMap" type="com.ydsw.domain.ModelFileStatus">
        <id property="id" column="id" />
        <result property="className" column="class_name" />
        <result property="dealStatus" column="deal_status" />
        <result property="filepath" column="filepath" />
        <result property="userName" column="user_name" />
        <result property="createUserid" column="create_userid" />
        <result property="createTime" column="create_time" />
        <result property="updateTime" column="update_time" />
        <result property="status" column="status" />
        <result property="dataIntroduction" column="data_introduction" />
        <result property="observationTime" column="observation_time" />
        <result property="type" column="type" />
        <result property="modelName" column="model_name"/>
        <result property="startTime" column="start_time"/>
        <result property="endTime" column="end_time"/>
    </resultMap>

    <sql id="Base_Column_List">
        id,class_name,deal_status,filepath,user_name,create_userid,
        create_time,update_time,status,data_introduction,observation_time,
        type,model_name,start_time,end_time
    </sql>

    <!-- 修正：原有参数名 modelFileStatusClass → modelFileStatus（和 Mapper 接口 @Param 一致） -->
    <update id="dropModelFileStatus">
        update model_file_status set status=1
        <where>
            <if test="ids != null and ids.size()>0">
                and id in
                <foreach collection="ids" open="(" close=")" item="item" separator="," index="index">
                    #{item}
                </foreach>
            </if>
            <if test="modelFileStatus.className!=null and modelFileStatus.className.trim()!=''">
                class_name = #{modelFileStatus.className}
            </if>
            <if test="modelFileStatus.userName!=null and modelFileStatus.userName.trim()!=''">
                and user_name = #{modelFileStatus.userName}
            </if>
            <if test="modelFileStatus.createUserid!=null and modelFileStatus.createUserid.trim()!=''">
                and create_userid=#{modelFileStatus.createUserid}
            </if>
            <if test="modelFileStatus.filepath!=null and modelFileStatus.filepath.trim()!=''">
                and filepath=#{modelFileStatus.filepath}
            </if>
            <if test="modelFileStatus.createTime!=null">
                and create_time=#{modelFileStatus.createTime}
            </if>
            <if test="modelFileStatus.observationTime!=null and modelFileStatus.observationTime.trim()!=''">
                and observation_time=#{modelFileStatus.observationTime}
            </if>
            <if test="modelFileStatus.startTime!=null and modelFileStatus.startTime.trim()!=''">
                and start_time=#{modelFileStatus.startTime}
            </if>
            <if test="modelFileStatus.endTime!=null and modelFileStatus.endTime.trim()!=''">
                and end_time=#{modelFileStatus.endTime}
            </if>
            and status =0
        </where>
    </update>

    <!-- 修正：1. 参数名 modelFileStatusClass → modelFileStatus  2. 去掉 type 字段的多余双引号 -->
    <update id="updateDealStatusViod">
        update model_file_status set deal_status = #{modelFileStatus.dealStatus}, type = #{modelFileStatus.type}
        <where>
            <if test="modelFileStatus.className!=null and modelFileStatus.className.trim()!=''">
                class_name = #{modelFileStatus.className}
            </if>
            <if test="modelFileStatus.userName!=null and modelFileStatus.userName.trim()!=''">
                and user_name = #{modelFileStatus.userName}
            </if>
            <if test="modelFileStatus.createUserid!=null and modelFileStatus.createUserid.trim()!=''">
                and create_userid=#{modelFileStatus.createUserid}
            </if>
            <if test="modelFileStatus.observationTime!=null and modelFileStatus.observationTime.trim()!=''">
                and observation_time=#{modelFileStatus.observationTime}
            </if>
            <if test="modelFileStatus.startTime!=null and modelFileStatus.startTime.trim()!=''">
                and start_time=#{modelFileStatus.startTime}
            </if>
            <if test="modelFileStatus.endTime!=null and modelFileStatus.endTime.trim()!=''">
                and end_time=#{modelFileStatus.endTime}
            </if>
            and deal_status != 'failed'
            and status=0;
        </where>
    </update>

    <!-- 修正：1. 参数名 modelFileStatusClass → modelFileStatus  2. 去掉字段的多余双引号 -->
    <select id="selectUserAndFileStatus" resultType="java.util.Map">
        select user_name as userName,
        create_userid as createUserid, deal_status as dealStatus,
        observation_time as observationTime, create_time as createTime,
        filepath, model_name as modelName, start_time as startTime,
        end_time as endTime
        from model_file_status
        <where>
            <if test="modelFileStatus.className!=null and modelFileStatus.className.trim()!=''">
                and class_name = #{modelFileStatus.className}
            </if>
            <if test="modelFileStatus.userName!=null and modelFileStatus.userName.trim()!=''">
                and user_name = #{modelFileStatus.userName}
            </if>
            <if test="modelFileStatus.createUserid!=null and modelFileStatus.createUserid.trim()!=''">
                and create_userid=#{modelFileStatus.createUserid}
            </if>
            <if test="modelFileStatus.observationTime!=null and modelFileStatus.observationTime.trim()!=''">
                and observation_time=#{modelFileStatus.observationTime}
            </if>
            <if test="modelFileStatus.dealStatus!=null and modelFileStatus.dealStatus.trim()!=''">
                and deal_status=#{modelFileStatus.dealStatus}
            </if>
            <if test="modelFileStatus.modelName!=null and modelFileStatus.modelName.trim()!=''">
                and model_name = #{modelFileStatus.modelName}
            </if>
            <if test="modelFileStatus.type!=null and modelFileStatus.type.trim()!=''">
                and type = #{modelFileStatus.type}
            </if>
            <if test="modelFileStatus.startTime!=null and modelFileStatus.startTime.trim()!=''">
                and start_time=#{modelFileStatus.startTime}
            </if>
            <if test="modelFileStatus.endTime!=null and modelFileStatus.endTime.trim()!=''">
                and end_time=#{modelFileStatus.endTime}
            </if>
            and status =0
        </where>
    </select>

    <select id="selectObservationTime" resultType="java.lang.String">
        SELECT DISTINCT  observation_time FROM model_file_status
        <where>
            status =0
            <if test="className!=null and className.trim()!=''">
                and class_name = #{className}
            </if>
        </where>
    </select>

    <select id="fetchObservationTimeByYear" resultType="java.lang.String">
        SELECT DISTINCT LEFT(observation_time, 4) FROM model_file_status
        <where>
            status =0
            <if test="className!=null and className.trim()!=''">
                and class_name = #{className}
            </if>
        </where>
    </select>

    <select id="fetchObservationTimeByMonth" resultType="java.lang.String">
        SELECT DISTINCT LEFT(observation_time, 7) FROM model_file_status
        <where>
            status =0
            <if test="className!=null and className.trim()!=''">
                and class_name = #{className}
            </if>
        </where>
    </select>

    <!-- ====================== 普通列表查询（queryModelFileStatusList） ====================== -->
    <select id="queryModelFileStatusList" resultType="java.util.Map">
        select
        id, user_name as userName, class_name as className, deal_status as dealStatus,
        filepath, create_userid as createUserid, type, start_time as startTime,
        end_time as endTime, observation_time as observationTime, model_name as modelName,
        data_introduction as dataIntroduction, create_time as createTime, update_time as updateTime
        from model_file_status
        <where>
            <if test="modelFileStatus.className!=null and modelFileStatus.className.trim()!=''">
                and class_name = #{modelFileStatus.className}
            </if>
            <if test="modelFileStatus.userName!=null and modelFileStatus.userName.trim()!=''">
                and user_name = #{modelFileStatus.userName}
            </if>
            <if test="modelFileStatus.dealStatus!=null and modelFileStatus.dealStatus.trim()!=''">
                and deal_status=#{modelFileStatus.dealStatus}
            </if>
            <if test="modelFileStatus.type!=null and modelFileStatus.type.trim()!=''">
                and type = #{modelFileStatus.type}
            </if>
            and status = 0
        </where>
        ORDER BY update_time DESC
    </select>

    <!-- ====================== 分页查询（queryModelFileStatusPage） ====================== -->
    <select id="queryModelFileStatusPage" resultType="java.util.Map">
        select
        id, user_name as userName, class_name as className, deal_status as dealStatus,
        filepath, create_userid as createUserid, type, start_time as startTime,
        end_time as endTime, observation_time as observationTime, model_name as modelName,
        data_introduction as dataIntroduction, create_time as createTime, update_time as updateTime
        from model_file_status
        <where>
            <if test="modelFileStatus.className!=null and modelFileStatus.className.trim()!=''">
                and class_name = #{modelFileStatus.className}
            </if>
            <if test="modelFileStatus.userName!=null and modelFileStatus.userName.trim()!=''">
                and user_name = #{modelFileStatus.userName}
            </if>
            <if test="modelFileStatus.dealStatus!=null and modelFileStatus.dealStatus.trim()!=''">
                and deal_status=#{modelFileStatus.dealStatus}
            </if>
            <if test="modelFileStatus.type!=null and modelFileStatus.type.trim()!=''">
                and type = #{modelFileStatus.type}
            </if>
            and status = 0
        </where>
        ORDER BY update_time DESC
    </select>

</mapper>